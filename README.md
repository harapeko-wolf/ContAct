# ContAct

温度感の低い見込み顧客の商談獲得サインを見逃さず、商談化を実現するコンテンツ配信ツール

## 開発環境のセットアップ

### 前提条件

- Docker Desktopがインストールされていること
- Gitがインストールされていること

### セットアップ手順

1. リポジトリのクローン
```bash
git clone git@github.com:<your-org>/ContAct.git
cd ContAct
```

2. Docker環境の起動
```bash
docker compose up -d
```

これで開発環境が構築され、以下のURLでアクセスできます：
- バックエンド: http://localhost:9000
- フロントエンド: http://localhost:3000

### 開発コマンド

#### バックエンド開発
```bash
# コンテナ内のシェルに接続
docker compose exec php bash

# マイグレーションの実行
php artisan migrate

# テストの実行
php artisan test
```

#### フロントエンド開発
```bash
# コンテナ内のシェルに接続
docker compose exec node sh

# 開発サーバーの起動
npm run dev

# テストの実行
npm run test
```

### その他のコマンド

```bash
# コンテナの停止
docker compose down

# コンテナの再起動
docker compose restart

# ログの確認
docker compose logs -f
```

## プロジェクト構成

```
/
├── backend/          # Laravelアプリケーション
├── frontend/         # Next.jsアプリケーション
├── docker/           # Docker関連ファイル
│   ├── nginx/        # Nginx設定
│   ├── mysql/        # MySQL設定
│   ├── php/          # PHP設定
│   └── node/         # Node.js設定
├── docs/             # ドキュメント
│   ├── architecture/ # アーキテクチャ図
│   ├── api/          # API仕様
│   └── adr/          # 設計決定記録
└── .github/          # GitHub Actionsワークフロー
```

## 開発フロー

1. `develop`ブランチから`feature/*`ブランチを作成
2. 機能開発
3. テストの実行
4. プルリクエストの作成
5. コードレビュー
6. マージ

## コントリビューションガイドライン

- コミットメッセージは[Conventional Commits](https://www.conventionalcommits.org/)に従う
- プルリクエストを作成する前にテストを実行
- コードレビューは1日以内に対応
- ドキュメントの更新を忘れない

## 必要なドキュメント

### 1. アーキテクチャ設計
- `docs/architecture/system-architecture.md`: システム全体のアーキテクチャ図
- `docs/architecture/database-schema.md`: データベーススキーマ図
- `docs/architecture/api-flow.md`: APIフロー図

### 2. API仕様
- `docs/api/openapi.yaml`: OpenAPI仕様書
- `docs/api/endpoints.md`: エンドポイント一覧と説明

### 3. 設計決定記録（ADR）
- `docs/adr/001-pdf-viewer-implementation.md`: PDFビューアの実装方針
- `docs/adr/002-tracking-implementation.md`: 閲覧トラッキングの実装方針
- `docs/adr/003-scoring-algorithm.md`: スコアリングアルゴリズムの設計

### 4. セキュリティ
- `docs/security/authentication.md`: 認証・認可の実装詳細
- `docs/security/data-protection.md`: データ保護方針

### 5. 運用
- `docs/operations/monitoring.md`: 監視設定とアラート
- `docs/operations/backup.md`: バックアップとリストア手順

## 不要なドキュメント

以下のドキュメントは削除または統合します：

1. 重複するセットアップ手順
2. 古いバージョンの設計ドキュメント
3. 実装されていない機能の仕様書

## ドキュメント更新ルール

1. 機能開発時は必ず関連ドキュメントを更新
2. API変更時はOpenAPI仕様を更新
3. 設計変更時はADRを追加
4. セキュリティ関連の変更はセキュリティドキュメントを更新

## 次のステップ

1. アーキテクチャ設計ドキュメントの作成
2. API仕様書の作成
3. 初期ADRの作成
4. セキュリティドキュメントの作成

## 概要

「ContAct」は、資料請求リードを商談化するためのPDFコンテンツ配信ツールです。  
PDFの閲覧状況を可視化し、ユーザーの関心度に応じて商談予約を促すことで、温度感の低い見込み顧客を効率的に商談へ誘導します。

---

## 1. タスクゴール

- 顧客ごとに生成された専用URLでPDFを配信
- 閲覧状況をトラッキング（ページ単位、滞在時間、複数回閲覧）
- 最終ページまで閲覧したユーザーにTimeRexでの予約モーダルを表示
- 閲覧データから商談スコアを算出し、管理画面で高スコア顧客を可視化
- 顧客がTimeRex予約を完了したかの状態を管理画面で確認可能にする

---

## 2. 主要機能

### ✅ フロントユーザー側機能（顧客用）

- UUIDによる限定URLでPDF閲覧ページにアクセス
- PDF.js によりPDFを1ページずつ表示（ページごとにイベントトラッキング）
- 最終ページ閲覧時にモーダルを表示  
  - TimeRexリンク（外部遷移）  
  - 「もう少し見る」選択肢（モーダルを閉じる）

### ✅ 管理画面側機能（社内利用）

- 顧客（会社名・メールアドレス）登録機能
- PDFファイルのアップロード・管理
- 顧客ごとの閲覧ログ一覧表示（ページ単位）
- 商談スコアの自動算出とフィルター
- TimeRexの予約完了フラグ表示（リダイレクト or タグベースで管理）

---

## 3. スコアリング定義案（ベストプラクティス）

以下の指標をもとに、商談スコア（最大100点）を自動算出：

| 指標                   | 条件例                        | 点数   |
|------------------------|-------------------------------|--------|
| 閲覧ページ数           | 全体の80%以上                 | +30点  |
| 総閲覧時間             | 60秒以上                      | +20点  |
| 特定ページの滞在時間   | 1ページあたり平均10秒以上     | +10点  |
| 同一資料の複数回閲覧   | 2回以上アクセス               | +20点  |
| 最終ページ到達         | 到達済み                      | +20点  |

- スコアが **70点以上** の場合は「期待度高」として管理画面上にラベル表示。

---

## 4. TimeRex連携仕様

- フロントで外部リンク遷移（iframeは使用しない）
- TimeRex予約ページURLは管理画面でPDFごとに登録可能
- 予約完了の検知方法：
  - TimeRex予約後に特定の**サンクスページ（自社）へリダイレクト**
  - リダイレクト時にUUIDを付与 → Laravel側でフラグ保存
  - 管理画面上で予約状態を表示

---

## 5. 顧客識別・リンク発行仕様

- 顧客登録時にUUIDを生成（`customers` テーブルで管理）
- PDF共有ごとに「顧客UUID + コンテンツUUID」組み合わせでURLを発行
- 例：`https://ContAct.jp/view/abcd1234-defg5678`
- このリンクを使ってPDFを閲覧したログをトラッキング

---

## 6. 使用技術スタック

- **フロントエンド**: Next.js 15 + TypeScript
  - PDF表示: `pdfjs-dist` + カスタムイベント処理
  - モーダル: `@headlessui/react` or `Radix UI`
- **バックエンド**: Laravel 12 + PHP 8.4
  - API: REST形式 / Laravel Sanctum認証
  - ログ保存: `view_logs` テーブルで管理
- **インフラ**: Docker Compose / AWS / Terraform / Ansible
- **CI/CD**: GitHub Actions / ECSデプロイ
- **監視**: Sentry

---

## 7. テーブル構成（概要）

### `customers`
| カラム名      | 型        | 説明                     |
|---------------|-----------|--------------------------|
| id            | UUID      | 主キー                   |
| name          | string    | 会社名                   |
| email         | string    | メールアドレス           |

### `pdfs`
| カラム名      | 型        | 説明                     |
|---------------|-----------|--------------------------|
| id            | UUID      | 主キー                   |
| title         | string    | PDFタイトル              |
| path          | string    | 保存先パス               |

### `view_links`
| カラム名        | 型        | 説明                       |
|-----------------|-----------|----------------------------|
| id              | UUID      | 主キー                     |
| customer_id     | UUID      | 顧客ID                     |
| pdf_id          | UUID      | PDF ID                     |
| uuid            | string    | 公開URL用UUID              |
| created_at      | datetime  | 発行日                     |

### `view_logs`
| カラム名        | 型        | 説明                         |
|-----------------|-----------|------------------------------|
| id              | bigint    | 主キー                       |
| view_link_id    | UUID      | 閲覧リンクUUID               |
| page_number     | int       | 閲覧したPDFページ番号        |
| viewed_at       | datetime  | 閲覧開始時刻                 |
| duration_sec    | int       | 表示時間（秒）               |

### `reservations`
| カラム名        | 型        | 説明                         |
|-----------------|-----------|------------------------------|
| id              | bigint    | 主キー                       |
| view_link_id    | UUID      | 閲覧リンクID                 |
| reserved_at     | datetime  | 予約完了時刻                 |

---

## 8. 今後のドキュメント連携

- `docs/specs/lead-to-meeting.md`: 本ドキュメント
- `docs/architecture.md`: 図解付きアーキテクチャ
- `docs/api/openapi.yaml`: Laravel API仕様
- `docs/adr/2025-05-pdf-tracking.md`: PDFトラッキング設計決定記録

---

## 9. セキュリティ対策

- PDFファイルのアクセス制御
  - 有効期限付きの署名付きURLによる一時的なアクセス
  - 不正アクセス防止のためのIP制限機能
- データ保護
  - 閲覧ログの暗号化保存
  - 定期的なバックアップと復旧テスト
- 認証・認可
  - 管理画面への多要素認証（MFA）対応
  - ロールベースのアクセス制御（RBAC）

---

## 10. プライバシーとデータ保護

- 収集するデータ
  - 閲覧履歴（ページ、時間、回数）
  - 顧客基本情報（会社名、メールアドレス）
  - 商談予約情報
- データの取り扱い
  - 個人情報の暗号化保存
  - データ保持期間の設定
  - データ削除リクエストへの対応
- コンプライアンス
  - GDPR対応
  - プライバシーポリシーの公開
  - データ処理契約（DPA）の提供

---

## 11. システム要件

### 推奨環境
- **ブラウザ**
  - Chrome 最新版
  - Firefox 最新版
  - Safari 最新版
  - Edge 最新版
- **モバイル対応**
  - iOS 最新版
  - Android 最新版
- **PDF表示要件**
  - JavaScript有効化必須
  - インターネット接続必須
  - 推奨画面解像度: 1280x720以上

### サーバー要件
- CPU: 2コア以上
- メモリ: 4GB以上
- ストレージ: 50GB以上（PDF保存用）
- ネットワーク: 100Mbps以上

---

## 12. トラブルシューティング

### よくある問題と解決方法
1. **PDFが表示されない場合**
   - ブラウザのキャッシュをクリア
   - JavaScriptが有効になっているか確認
   - インターネット接続を確認

2. **閲覧ログが記録されない場合**
   - ブラウザの拡張機能を一時的に無効化
   - プライベートブラウジングモードを試す
   - システム管理者に連絡

3. **予約モーダルが表示されない場合**
   - 最終ページまで到達しているか確認
   - ブラウザのポップアップブロックを確認
   - システム管理者に連絡

### サポート窓口
- 技術サポート: support@ContAct.jp
- 緊急連絡先: 03-XXXX-XXXX（平日9:00-18:00）

---

## 13. ソースコード構成

```
ContAct/
├── frontend/                 # Next.js フロントエンド
│   ├── src/
│   │   ├── app/             # ページコンポーネント
│   │   ├── components/      # 共通コンポーネント
│   │   ├── hooks/          # カスタムフック
│   │   ├── lib/            # ユーティリティ関数
│   │   ├── styles/         # スタイルシート
│   │   └── types/          # TypeScript型定義
│   ├── public/             # 静的ファイル
│   └── tests/              # フロントエンドテスト
│
├── backend/                 # Laravel バックエンド
│   ├── app/
│   │   ├── Console/        # コンソールコマンド
│   │   ├── Http/           # コントローラー
│   │   ├── Models/         # モデル
│   │   ├── Services/       # ビジネスロジック
│   │   └── Events/         # イベント
│   ├── config/             # 設定ファイル
│   ├── database/           # マイグレーション
│   ├── routes/             # ルーティング
│   └── tests/              # バックエンドテスト
│
├── docs/                    # ドキュメント
│   ├── specs/              # 仕様書
│   ├── architecture/       # アーキテクチャ図
│   └── api/                # API仕様
│
├── docker/                  # Docker設定
│   ├── frontend/           # フロントエンドDockerfile
│   ├── backend/            # バックエンドDockerfile
│   └── nginx/              # Nginx設定
│
├── terraform/              # インフラ構成
│   ├── modules/            # 再利用可能なモジュール
│   └── environments/       # 環境別設定
│
└── scripts/                # 各種スクリプト
    ├── deploy/             # デプロイ用スクリプト
    ├── setup/              # セットアップ用スクリプト
    └── tools/              # 開発支援ツール
```

### 主要ディレクトリの説明

- **frontend/**
  - Next.jsによるフロントエンドアプリケーション
  - PDF表示、トラッキング、モーダル表示などの機能を実装
  - コンポーネントは機能単位で構成
  - 共通コンポーネントは再利用性を重視

- **backend/**
  - LaravelによるバックエンドAPI
  - ユーザー管理、PDF管理、閲覧ログ管理を実装
  - サービス層でビジネスロジックを分離

- **docs/**
  - プロジェクトの各種ドキュメント
  - 仕様書、アーキテクチャ図、API仕様を管理

- **docker/**
  - 開発・本番環境のコンテナ設定
  - フロントエンド、バックエンド、Nginxの設定を管理

- **terraform/**
  - AWSリソースの構成管理
  - 環境ごとの設定を分離して管理

- **scripts/**
  - 開発・デプロイ支援用のスクリプト
  - 環境構築、デプロイ、テスト実行などを自動化

## 14. フロントエンド設計方針

### コンポーネント構成

```
frontend/src/components/
├── common/              # 共通コンポーネント
│   ├── Button/         # ボタンコンポーネント
│   ├── Input/          # 入力フィールド
│   ├── Modal/          # モーダル
│   └── Layout/         # レイアウト関連
│
├── features/           # 機能別コンポーネント
│   ├── pdf-viewer/    # PDF表示機能
│   ├── tracking/      # トラッキング機能
│   └── reservation/   # 予約機能
│
└── pages/             # ページコンポーネント
    ├── admin/         # 管理画面
    └── viewer/        # PDF閲覧画面
```

### 設計原則

1. **機能単位の分割**
   - 関連する機能は同じディレクトリにまとめる
   - コンポーネントは単一責任の原則に従う
   - 再利用可能なロジックはカスタムフックに分離

2. **状態管理**
   - ローカル状態はReactのuseState/useReducerを使用
   - グローバル状態は必要最小限に抑える
   - コンテキストは認証情報など限定的な用途に使用

3. **スタイリング**
   - Tailwind CSSを使用したユーティリティファースト
   - 共通スタイルはコンポーネントに閉じ込める
   - レスポンシブデザインを優先

4. **パフォーマンス最適化**
   - コンポーネントのメモ化を適切に使用
   - 画像の最適化と遅延読み込み
   - コード分割による初期ロード時間の短縮

5. **テスト容易性**
   - コンポーネントは単体テスト可能な粒度に分割
   - ビジネスロジックはカスタムフックに分離
   - モックデータを使用したテスト環境の整備
```

## CI/CD

### GitHub Actions

- プッシュ/プルリクエスト時に自動的にテストが実行されます
- テストが成功すると、Dockerイメージが自動的にビルドされ、Docker Hubにプッシュされます
- README.mdやdocs/ディレクトリの変更はCIをスキップします

### テスト環境

- バックエンド: PHP 8.4 + MySQL 8.4
- フロントエンド: Node.js 21

### デプロイ

- リリース時はタグ付けでECSデプロイが自動化されます